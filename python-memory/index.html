<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><link href=//gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=generator content="Hugo 0.63.2"><meta name=viewport content="width=device-width,initial-scale=1"><title>Python Memory Management &#183; Dacio's Tech Blog</title><link type=text/css rel=stylesheet href=https://blog.dacio.dev/css/print.css media=print><link type=text/css rel=stylesheet href=https://blog.dacio.dev/css/poole.css><link type=text/css rel=stylesheet href=https://blog.dacio.dev/css/syntax.css><link type=text/css rel=stylesheet href=https://blog.dacio.dev/css/hyde.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700"><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png></head><body><aside class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><a href=https://blog.dacio.dev/><h1>Dacio's Tech Blog</h1></a><p class=lead>The blog of an SF-based learner/programmer.</p></div><nav><ul class=sidebar-nav><li><a href=https://blog.dacio.dev/>Home</a></li></ul></nav><p>&copy; 2020. All rights reserved.</p></div></aside><main class="content container"><div class=post><h1>Python Memory Management</h1><time datetime=2019-05-15T09:33:28-0700 class=post-date>Wed, May 15, 2019</time><h1 id=managing-memory>Managing Memory</h1><p>An assignment that <a href=https://medium.com/@jasmine.yhumbert>Jasmine</a> and I had recently done for my instructor, <a href=https://www.linkedin.com/in/alancdavis/>Alan Davis</a>, at <a href=https://www.makeschool.com/>Make School</a> was given a large list of phone routes consisting of their standardized prefixes and costs.</p><p>The task was for increasing amounts of routes and phone numbers to find the longest matches and their prices.</p><p><a href=https://github.com/Make-School-Courses/CS-1.3-Core-Data-Structures/blob/a622779357b055f925feb5f000996cb26c2ddf66/project/ReadMe.md>Project Readme</a></p><h2 id=attempts>Attempts</h2><h4 id=list>List</h4><p>One being performing linear search on a list of phone numbers because I couldn&rsquo;t figure out a way to perform binary search.</p><p><a href=https://github.com/lacunahag/call_routing_project/blob/e05e1577fc2f946b268ac4451fd7e11d4a8d6501/scenario1.py>File</a></p><h4 id=dictionary>Dictionary</h4><p>Our next step was to throw it all into a dictionary and keep removing characters off of my numbers until there was a match.</p><p><a href=https://github.com/lacunahag/call_routing_project/blob/e8d1fbe7a2d8560fd27e1b99ab9b445ad994e2a1/scenario2.py>File</a></p><h4 id=trie>Trie</h4><p>Jasmine said that <a href=https://en.wikipedia.org/wiki/Trie>tries</a> might be a good solution. You can read more about them <a href=https://medium.com/basecs/trying-to-understand-tries-3ec6bede0014>here</a>. Basically, they are a way of storing sequences of values, most commonly being strings.</p><p>To our dismay, it was using <em><strong>3 GB of RAM</strong></em> on a 10 million route dataset! When Jasmine tried to build her own it actually crashed on her laptop with 8 GB of RAM in total.</p><p><em><strong>It was time to track down where all our RAM is going.</strong></em></p><h1 id=tips-and-resources>Tips and Resources</h1><p>Through my attempts to optimize the memory, I have some pointers.</p><h2 id=pymplerhttpspythonhostedorgpympler><a href=https://pythonhosted.org/Pympler/>Pympler</a></h2><p>Pympler is a powerful tool to analyze memory usage.</p><h3 id=pymplerasizeofasizeofhttpspythonhostedorgpymplerlibraryasizeofhtmlhighlightasizeof20asizeofpymplerasizeofasizeof><a href="https://pythonhosted.org/Pympler/library/asizeof.html?highlight=asizeof%20asizeof#pympler.asizeof.asizeof">pympler.asizeof.asizeof</a></h3><p>This function recursively checks every object referenced by several objects allowing you to get the actual size in bytes.</p><h3 id=pymplertrackersummarytrackerhttpspythonhostedorgpymplerlibrarytrackerhtmlhighlightsummarytrackerpymplertrackersummarytracker><a href="https://pythonhosted.org/Pympler/library/tracker.html?highlight=summarytracker#pympler.tracker.SummaryTracker">pympler.tracker.SummaryTracker</a></h3><p>This class has a function called <code>print_diff</code> shows you how many of each type of new object there are and the amount of memory that they take up. This is useful</p><p>This tracker is telling me that I should figure out how to <em>reduce the number of subtries</em> that I&rsquo;m creating and perhaps find another way to use lists.</p><p>The first time I used it I realized that I needed to <strong>stop using so many dictionaries</strong>. If I know the exact inputs my Trie will be receiving I could use one dictionary to map characters to parts of a list.</p><h3 id=much-much-more>Much much more</h3><p>Pympler has much more in store, I&rsquo;d highly recommend going through their documentation and seeing if there&rsquo;s anything of use.</p><h2 id=tracemallochttpsdocspythonorg3librarytracemallochtml><a href=https://docs.python.org/3/library/tracemalloc.html>tracemalloc</a></h2><p>Python 3.4 and up has a built-in memory tracer, but I admit I don&rsquo;t have as much experience with it.</p><h2 id=use-__slots__>Use <code>__slots__</code>!</h2><p>Slots in Python are a pretty quick way to reduce the memory usage of an object. By default Python uses dictionaries to store class attributes which you find in the variable <code>__dict__</code>.</p><p>If you instead explicitly define which variables using <code>__slots__</code> your object will have you can save a <em>substantial</em> amount of memory which pays off with recursive data structures like tries.</p><p>By using slots more than halved our memory usage while still storing the same data.</p><h2 id=default-to-none>Default to None</h2><p>In my Tries, I realized that there are a lot of moments when a Trie won&rsquo;t have any subtries, but I still made a list for them.</p><p>Although there&rsquo;s a bit of a tradeoff, I believe in situations where you have 4.6 million of the same object it&rsquo;s worth it to default variables to None and only creates them when necessary</p><p>You can see that with more than <strong>4 million nodes</strong> the size of both empty dictionaries and empty lists can add up <em>incredibly</em> quickly.</p><blockquote><p>You should only create data structures when they&rsquo;re being used.</p></blockquote><h2 id=use-smaller-types>Use Smaller Types</h2><p>You might fall into the pattern of reusing one datatype multiple times because it worked like a dictionary.</p><blockquote><p>Nested dictionaries are common, but what if the keys are predictable?</p></blockquote><p>In our phone number problem, I realized that there were only going to be 11 characters &ldquo;+1234567890&rdquo;, so why should I use a data structure optimized for arbitrary keys?</p><p>I decided it would be worth it to create a &ldquo;mapper&rdquo; that converts a character into an index in a list.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span style=color:#66d9ef>def</span> __init__(self, keys <span style=color:#f92672>=</span> None, items <span style=color:#f92672>=</span> None, _value <span style=color:#f92672>=</span> None, _mapper <span style=color:#f92672>=</span>  None):
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span>  <span style=color:#66d9ef>if</span> _mapper:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span>    self<span style=color:#f92672>.</span>_mapper <span style=color:#f92672>=</span> _mapper
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span>  <span style=color:#66d9ef>elif</span> keys:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span>    self<span style=color:#f92672>.</span>_mapper <span style=color:#f92672>=</span> {item: index <span style=color:#66d9ef>for</span> index, item <span style=color:#f92672>in</span> enumerate(keys)}
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span>  <span style=color:#66d9ef>else</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span>    <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>ValueError</span>(<span style=color:#e6db74></span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>keys or _mapper must be provided</span><span style=color:#e6db74>&#39;</span>)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">9</span>  self<span style=color:#f92672>.</span>_subtries <span style=color:#f92672>=</span> None
</code></pre></div><p><a href=https://github.com/lacunahag/call_routing_project/commit/4605171ef87696d555b880f41f9101b5041bc54c>Commit</a></p><p>This allows me to generate a mapper at the root and pass it down. I can then use it to get the index of where a Trie <em>should</em> be. This was <strong>by far</strong> one of the best optimizations that I made and reduced my memory usage from around <strong>3 GB to 1.5 GB</strong>.</p><h1 id=conclusion>Conclusion</h1><p>Optimizing your code for memory usage might not be one of the first things you might think to do. Once you&rsquo;re operating at scale, however, it becomes just as important as speed.</p><p>Take a look at <a href=https://github.com/lacunahag/call_routing_project>our repo</a> if you want to see our solution to the phone numbers problem</p><blockquote><p>I&rsquo;m looking for internships, so don&rsquo;t be afraid to reach out! <a href=https://www.linkedin.com/in/dacioromero/>My LinkedIn</a></p></blockquote></div><h2>Comments</h2><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"dacio"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></main></body></html>